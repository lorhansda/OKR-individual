<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-signin-client_id" content="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com">
<title>Dashboard de OKRs - CS (Nova Versão)</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/*
       -- REESTILIZAÇÃO VISUAL COMPLETA --
       O código CSS abaixo foi totalmente reescrito para criar uma interface mais moderna,
       atraente e dinâmica, conforme solicitado. Nenhuma funcionalidade ou ID utilizado
       pelo JavaScript foi alterado. O foco foi em layout, cores, tipografia e interatividade.
       */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

:root {
--primary-color: #007BFF;
--primary-hover-color: #0056b3;
--secondary-color: #28a745;
--danger-color: #dc3545;
--warning-color: #ffc107;

--bg-color: #121828;
--bg-gradient: linear-gradient(180deg, #1a2238 0%, #121828 30%);
--card-bg-color: #1a2238;
--text-color: #F0F2F5;
--text-light-color: #a9b3c1;
--border-color: #3a476a;
--shadow-color: rgba(0, 0, 0, 0.2);
--font-family: 'Inter', sans-serif;
--border-radius-lg: 16px;
--border-radius-md: 12px;
--border-radius-sm: 8px;
}

body.light-theme {
--primary-color: #007BFF;
--primary-hover-color: #0069d9;
--bg-color: #f4f7fc;
--bg-gradient: linear-gradient(180deg, #ffffff 0%, #f4f7fc 40%);
--card-bg-color: #ffffff;
--text-color: #2c3e50;
--text-light-color: #57606A;
--border-color: #e3e8f0;
--shadow-color: rgba(99, 112, 134, 0.15);
}

*, *::before, *::after {
box-sizing: border-box;
}

body {
font-family: var(--font-family);
background: var(--bg-gradient) no-repeat;
background-color: var(--bg-color);
margin: 0;
padding: 24px;
color: var(--text-color);
line-height: 1.6;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
transition: background-color 0.3s, color 0.3s;
}

/* --- LOGIN STYLES --- */
#login-container {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 90vh;
text-align: center;
}

#login-container h1 {
font-size: 2.5rem;
font-weight: 700;
margin-bottom: 15px;
color: var(--text-color);
}

#login-container p {
font-size: 1.2rem;
color: var(--text-light-color);
margin-bottom: 40px;
max-width: 500px;
}

#dashboard-wrapper {
display: none; /* Inicia oculto */
}

.container {
max-width: 1800px;
margin: auto;
padding: 0 20px;
}

@keyframes fadeInDown {
from { opacity: 0; transform: translateY(-15px); }
to { opacity: 1; transform: translateY(0); }
}

header {
text-align: center;
margin-bottom: 40px;
position: relative;
animation: fadeInDown 0.6s ease-out;
}

header h1 {
font-size: 2.8rem;
font-weight: 800;
color: var(--text-color);
margin: 0 0 8px 0;
letter-spacing: -1px;
}

header p {
font-size: 1.2rem;
color: var(--text-light-color);
margin: 0;
}

.revision-marker {
position: absolute;
top: 5px;
left: 5px;
background-color: var(--border-color);
color: var(--text-light-color);
padding: 5px 15px;
border-radius: var(--border-radius-sm);
font-size: 0.8rem;
font-weight: 600;
}

.header-actions {
position: absolute;
top: 0;
right: 0;
display: flex;
align-items: center;
gap: 15px;
background-color: var(--card-bg-color);
padding: 8px 12px;
border-radius: var(--border-radius-lg);
border: 1px solid var(--border-color);
}

#settings-button, #export-csv-button, #export-html-button, #bulk-export-button, #clear-cache-button {
background: none; border: none;
color: var(--text-light-color);
font-size: 1.5rem; cursor: pointer;
transition: color 0.3s ease, transform 0.3s ease, opacity 0.3s;
}
#settings-button:hover {
color: var(--primary-color);
transform: rotate(45deg);
}
#clear-cache-button:hover {
color: var(--warning-color);
transform: scale(1.1);
}
#export-csv-button:hover, #bulk-export-button:hover {
color: var(--secondary-color);
transform: scale(1.1);
}
#export-html-button:hover {
color: var(--primary-color);
transform: scale(1.1);
}
#export-csv-button:disabled, #export-html-button:disabled {
opacity: 0.4;
cursor: not-allowed;
transform: none;
color: var(--text-light-color);
}

.theme-switcher { display: flex; align-items: center; gap: 12px; }
.theme-switcher .fa-sun, .theme-switcher .fa-moon { font-size: 1.2rem; color: var(--text-light-color); }
.theme-switcher .fa-sun { opacity: 0.5; }
body.light-theme .theme-switcher .fa-moon { opacity: 0.5; }
body.light-theme .theme-switcher .fa-sun { opacity: 1; }

.switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 24px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--primary-color); }
input:checked + .slider:before { transform: translateX(20px); }

.controls {
display: flex;
gap: 20px;
padding: 20px;
background-color: var(--card-bg-color);
border-radius: var(--border-radius-lg);
margin-bottom: 30px;
flex-wrap: wrap;
justify-content: center;
align-items: flex-end;
border: 1px solid var(--border-color);
box-shadow: 0 4px 15px var(--shadow-color);
animation: fadeInDown 0.7s ease-out;
}

.onboarding-controls {
display: flex;
gap: 20px;
padding: 20px;
background-color: color-mix(in srgb, var(--primary-color) 8%, transparent);
border-radius: var(--border-radius-lg);
margin-bottom: 30px;
flex-wrap: wrap;
justify-content: center;
align-items: flex-end;
border: 1px solid var(--primary-color);
}


.control-group { display: flex; flex-direction: column; }
.control-group label {
font-weight: 600;
margin-bottom: 10px;
color: var(--text-color);
font-size: 0.9rem;
}
.control-group input[type="file"], .control-group select {
padding: 12px 15px;
border-radius: var(--border-radius-sm);
border: 1px solid var(--border-color);
min-width: 180px;
background-color: var(--bg-color);
color: var(--text-color);
font-family: var(--font-family);
font-size: 1rem;
transition: border-color 0.3s ease, box-shadow 0.3s ease;
-webkit-appearance: none;
-moz-appearance: none;
appearance: none;
background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a9b3c1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
background-repeat: no-repeat;
background-position: right 15px center;
background-size: 1em;
}
body.light-theme .control-group select {
background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2357606A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
}

.control-group input[type="file"] { background-image: none; cursor: pointer;}
.control-group input[type="file"]::file-selector-button {
background-color: var(--primary-color);
color: #fff;
border: none;
padding: 8px 12px;
border-radius: var(--border-radius-sm);
cursor: pointer;
margin-right: 10px;
transition: background-color 0.2s;
}
.control-group input[type="file"]::file-selector-button:hover { background-color: var(--primary-hover-color); }

.control-group select:hover, .control-group input[type="file"]:hover { border-color: var(--primary-color); }
.control-group select:focus {
outline: none;
border-color: var(--primary-color);
box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 30%, transparent);
}
body.light-theme .control-group input[type="file"], 
body.light-theme .control-group select { background-color: #FFFFFF; }

.tabs {
display: flex;
gap: 5px;
border-bottom: 2px solid var(--border-color);
margin-bottom: 30px;
}
.tab-button {
padding: 12px 25px; cursor: pointer; background-color: transparent;
border: none; border-bottom: 4px solid transparent;
font-size: 1.1rem; font-weight: 600;
color: var(--text-light-color);
transition: color 0.3s ease, border-color 0.3s ease;
position: relative; top: 2px;
}
.tab-button:hover { color: var(--text-color); }
.tab-button.active {
color: var(--primary-color);
border-bottom-color: var(--primary-color);
}

.tab-content { display: none; }
.tab-content.active {
display: block;
animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

.metric-group { margin-bottom: 50px; }
.group-title {
font-size: 1.8rem; font-weight: 700;
color: var(--text-color); margin: 0 0 25px 0;
padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
display: flex; align-items: center;
}
.group-title::before {
content: '';
display: inline-block;
width: 5px; height: 28px;
background-color: var(--primary-color);
margin-right: 15px;
border-radius: 5px;
}

.group-content {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
gap: 25px;
}

.card {
background-color: var(--card-bg-color);
border-radius: var(--border-radius-lg);
padding: 25px; border: 1px solid var(--border-color);
transition: transform 0.3s ease, box-shadow 0.3s ease;
display: flex; flex-direction: column;
box-shadow: 0 4px 15px var(--shadow-color);
animation: fadeIn 0.5s ease-out backwards;
}
.card:hover {
transform: translateY(-8px);
box-shadow: 0 12px 25px var(--shadow-color);
}

.card h3 {
margin-top: 0; color: var(--text-color);
border-bottom: 1px solid var(--border-color);
padding-bottom: 15px; font-size: 1.25rem;
font-weight: 600; margin-bottom: 20px;
display: flex; align-items: center; gap: 10px;
position: relative; /* Necessário para posicionar o botão de gráfico */
}
.card h3::before {
font-family: "Font Awesome 6 Free";
font-weight: 900;
color: var(--primary-color);
}

.card h3:contains("Adoção do Modelo de Negócio")::before { content: '\f085'; }
.card h3:contains("Tipos de Contato")::before { content: '\f0e0'; }
.card h3:contains("Visão Geral")::before { content: '\f0c8'; }
.card h3:contains("Atividades de Plano")::before { content: '\f55b'; }
.card h3:contains("Atividades de Adoção")::before { content: '\f518'; }
.card h3:contains("Follow-Up")::before { content: '\f27a'; }
.card h3:contains("Discovery")::before { content: '\f002'; }
.card h3:contains("Engajamento")::before { content: '\f57d'; }
.card h3:contains("Reuniões de QBR")::before { content: '\f073'; }
.card h3:contains("Planos de Sucesso")::before { content: '\f19d'; }
.card h3:contains("Baixo Engajamento")::before { content: '\f7a4'; }
.card h3:contains("Geral do Onboarding")::before { content: '\f500'; }
.card h3:contains("Contatos em Onboarding")::before { content: '\f2b9'; }
.card h3:contains("Atividades em Onboarding")::before { content: '\f0ae'; }
.card h3:contains("Média de Cobertura")::before { content: '\f51a'; }
.card h3:contains("Total:")::before { content: '\f681'; }



.trend-chart-button {
position: absolute;
top: -5px;
right: -5px;
background-color: var(--card-bg-color);
border: 1px solid var(--border-color);
color: var(--text-light-color);
width: 36px;
height: 36px;
border-radius: 50%;
cursor: pointer;
font-size: 1rem;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s ease;
}

.trend-chart-button:hover {
color: var(--primary-color);
border-color: var(--primary-color);
transform: rotate(15deg) scale(1.1);
box-shadow: 0 2px 10px var(--shadow-color);
}

.card-content { flex-grow: 1; }

.metric {
display: flex; justify-content: space-between; align-items: center;
margin-bottom: 8px; font-size: 1rem; padding: 12px 8px;
border-radius: var(--border-radius-sm);
transition: background-color 0.2s ease;
}
.metric:last-of-type { margin-bottom: 0; }
.metric[data-metric-id] { cursor: pointer; }
.metric[data-metric-id]:hover {
background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
}
.metric-label { color: var(--text-light-color); font-weight: 500; }
.metric-value { font-weight: 700; color: var(--text-color); font-size: 1.6rem; }
.metric-value.success { color: var(--secondary-color); }
.metric-value.danger { color: var(--danger-color); }
.metric-value .sub-metric {
font-size: 0.9rem; font-weight: 500;
color: var(--text-light-color); margin-left: 8px;
}

.progress-bar-container {
display: flex; align-items: center; gap: 15px;
margin-top: 20px;
}
.progress-bar {
flex-grow: 1;
background-color: var(--border-color);
border-radius: 25px; height: 12px;
overflow: hidden;
}
.progress-bar-fill {
background: var(--primary-color);
height: 100%; width: 0%;
transition: width 1s cubic-bezier(0.25, 1, 0.5, 1);
border-radius: 25px;
}
.progress-percentage {
font-size: 0.9rem; font-weight: 600;
color: var(--text-color);
flex-shrink: 0;
}

.loader {
text-align: center; padding: 60px; font-weight: 600;
grid-column: 1 / -1;
background-color: var(--card-bg-color);
border: 1px dashed var(--border-color);
border-radius: var(--border-radius-lg); font-size: 1.2rem;
}

.data-table-wrapper {
background-color: var(--card-bg-color);
border-radius: var(--border-radius-lg); padding: 25px;
border: 1px solid var(--border-color);
margin-bottom: 30px;
box-shadow: 0 4px 15px var(--shadow-color);
}
.data-table-wrapper h3 { margin: 0 0 20px 0; font-size: 1.5rem; }
.data-table-container { max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.95rem; }
.data-table td span[data-client-name] { cursor: pointer; color: var(--primary-color); font-weight: 500; transition: color 0.2s; }
.data-table td span[data-client-name]:hover { color: var(--primary-hover-color); }
.data-table thead { position: sticky; top: 0; background-color: var(--bg-color); z-index: 10; }
.data-table th { font-weight: 600; color: var(--text-color); }
.data-table tbody tr:nth-child(even) { background-color: color-mix(in srgb, var(--border-color) 20%, transparent); }
.data-table tbody tr:hover { background-color: color-mix(in srgb, var(--primary-color) 15%, transparent); }

body.light-theme .data-table thead { background-color: #f6f8fa; }
body.light-theme .data-table tbody tr:nth-child(even) { background-color: #f6f8fa; }
body.light-theme .data-table tbody tr:hover { background-color: #e3e8f0; }

.pagination-controls { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px 5px 10px; color: var(--text-light-color); }
.pagination-controls button {
padding: 8px 16px; cursor: pointer;
border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);
background-color: color-mix(in srgb, var(--border-color) 40%, transparent);
color: var(--text-color); font-weight: 600;
transition: all 0.2s ease;
}
.pagination-controls button:hover:not(:disabled) {
background-color: var(--primary-color);
color: #fff; border-color: var(--primary-color);
}
.pagination-controls button:disabled { cursor: not-allowed; opacity: 0.5; }

/* --- CORREÇÃO DE SCROLL DO MODAL --- */
.modal {
display: none; position: fixed; z-index: 1000;
left: 0; top: 0; width: 100%; height: 100%;
background-color: rgba(0,0,0,0.7);
backdrop-filter: blur(8px);
-webkit-backdrop-filter: blur(8px);
animation: fadeInModal 0.3s ease;
overflow-y: auto; /* Permite a rolagem do fundo escuro */
padding: 4% 20px; /* Adiciona espaçamento vertical e horizontal */
}
@keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

/* --- CORREÇÃO DE SCROLL DO MODAL --- */
.modal-content {
background-color: var(--card-bg-color);
margin: 0 auto; /* Remove a margem vertical para a rolagem funcionar corretamente */
padding: 35px;
border: 1px solid var(--border-color);
width: 90%; max-width: 1400px;
border-radius: var(--border-radius-lg);
box-shadow: 0 15px 40px rgba(0,0,0,0.4);
animation: slideInModal 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}
@keyframes slideInModal {
from { opacity: 0; transform: translateY(-30px) scale(0.98); }
to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
.modal-header h2 { color: var(--primary-color); margin: 0; font-size: 1.8rem; font-weight: 700; }
.close-button {
color: var(--text-light-color); font-size: 2rem;
cursor: pointer; transition: color 0.2s ease, transform 0.2s ease;
width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
}
.close-button:hover, .close-button:focus { color: var(--danger-color); transform: rotate(90deg); }

.modal-search-container { padding-bottom: 20px; }
#modal-search-input {
width: 100%; padding: 12px 20px;
border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);
background-color: var(--bg-color); color: var(--text-color);
font-size: 1rem; font-family: var(--font-family);
}
#modal-search-input:focus {
outline: none; border-color: var(--primary-color);
box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 30%, transparent);
}
body.light-theme #modal-search-input { background-color: #FFFFFF; }

#settings-modal .modal-content { max-width: 650px; }
#trend-chart-modal .modal-content { max-width: 900px; }
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
.settings-grid .control-group { min-width: unset; }
.settings-grid input[type="number"] {
width: 100%; background-color: var(--bg-color);
border-color: var(--border-color); color: var(--text-color);
padding: 12px 15px; border-radius: var(--border-radius-sm);
font-size: 1rem;
}
#save-settings-button {
grid-column: 1 / -1; padding: 14px;
font-size: 1.1rem; font-weight: 600;
background-color: var(--primary-color); color: #fff;
border: none; border-radius: var(--border-radius-sm);
cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease;
}
#save-settings-button:hover { background-color: var(--primary-hover-color); }
#save-settings-button:active { transform: scale(0.98); }

#client-360-modal .client-info {
display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 25px; margin-bottom: 25px; padding-bottom: 25px;
border-bottom: 1px solid var(--border-color);
}
#client-360-modal .client-info-item {
background-color: var(--bg-color); padding: 15px;
border-radius: var(--border-radius-md);
}
#client-360-modal .client-info-label { font-size: 0.9rem; color: var(--text-light-color); margin-bottom: 8px; display: block; }
#client-360-modal .client-info-value { font-size: 1.3rem; font-weight: 700; color: var(--text-color); }

body.light-theme .settings-grid input[type="number"] {
background-color: #FFFFFF; border-color: #D0D7DE; color: #24292F;
}

.divergence-info {
background-color: color-mix(in srgb, var(--warning-color) 15%, transparent);
border: 1px solid var(--warning-color); color: var(--warning-color);
padding: 15px 20px; border-radius: var(--border-radius-md);
margin-bottom: 30px; text-align: center;
font-weight: 600; cursor: pointer;
transition: background-color 0.2s;
display: flex; align-items: center; justify-content: center; gap: 10px;
}
.divergence-info:hover { background-color: color-mix(in srgb, var(--warning-color) 25%, transparent); }
.divergence-info::before {
font-family: "Font Awesome 6 Free"; content: '\f071';
font-weight: 900;
}

.trend-indicator {
font-size: 0.95rem; font-weight: 700;
margin-left: 10px; vertical-align: middle;
padding: 3px 8px; border-radius: 6px;
}
.trend-positive { color: var(--secondary-color); background-color: color-mix(in srgb, var(--secondary-color) 15%, transparent); }
.trend-negative { color: var(--danger-color); background-color: color-mix(in srgb, var(--danger-color) 15%, transparent); }
.trend-neutral { color: var(--text-light-color); background-color: color-mix(in srgb, var(--text-light-color) 15%, transparent); }

.overdue-metric {
padding-top: 10px !important;
border-top: 1px dashed var(--border-color) !important;
margin-top: 10px !important;
}
.overdue-metric .metric-label {
font-size: 0.9rem; font-weight: 500;
color: var(--warning-color);
}
.overdue-metric .metric-label .fa-history,
.overdue-metric .metric-label .fa-exclamation-triangle { 
margin-right: 6px; 
}
.overdue-metric .metric-value {
font-size: 1.2rem; color: var(--warning-color);
}
.metric.overdue-metric .metric-value.danger {
color: var(--danger-color);
}

/* INÍCIO CSS NOVO */
#cs-selection-list .cs-item {
display: block;
margin-bottom: 10px;
}
#cs-selection-list .cs-item label {
font-size: 1.1rem;
cursor: pointer;
display: flex;
align-items: center;
}
#cs-selection-list .cs-item input {
width: 20px;
height: 20px;
margin-right: 15px;
cursor: pointer;
}
#generate-bulk-reports-button:hover {
background-color: #218838 !important;
}
/* FIM CSS NOVO */
/* INÍCIO CSS NOVO - CARD DE USUÁRIO */
#user-info-card {
position: absolute;
top: 15px;
left: 20px;
background-color: var(--card-bg-color);
color: var(--text-light-color);
padding: 8px 15px;
border-radius: var(--border-radius-md);
font-size: 0.9rem;
font-weight: 600;
display: flex;
align-items: center;
gap: 15px;
border: 1px solid var(--border-color);
z-index: 10;
box-shadow: 0 4px 15px var(--shadow-color);
animation: fadeInDown 0.6s ease-out;
}

#logout-button {
background: none;
border: none;
color: var(--danger-color);
cursor: pointer;
font-size: 1.1rem;
transition: transform 0.2s ease, color 0.2s ease;
opacity: 0.7;
}

#logout-button:hover {
transform: scale(1.1);
opacity: 1;
}
/* FIM CSS NOVO */

</style>
</head>
<body>
<div id="login-container">
<h1>Dashboard de OKRs</h1>
<p>Por favor, faça login com sua conta Google para acessar os dados de performance.</p>
<div id="g_id_onload"
data-client_id="232267534625-oju4j8ob02rn6tim24tcdas26c5rh3j4.apps.googleusercontent.com"
data-callback="handleCredentialResponse">
</div>
<div class="g_id_signin"
data-type="standard"
data-size="large"
data-theme="outline"
data-text="sign_in_with"
data-shape="rectangular"
data-logo_alignment="left">
</div>
</div>

<div id="dashboard-wrapper">
<div class="container">
<header>
<div id="user-info-card" style="display: none;">
<span id="user-info-text"></span>
<button id="logout-button" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
</div>
<h1>Dashboard de OKRs</h1>
<p>Avaliação de Resultados e Performance</p>
<div class="header-actions">
<button id="clear-cache-button" title="Limpar Dados em Cache e Recarregar">
    <i class="fas fa-broom"></i>
</button>
<div class="theme-switcher">
<i class="fas fa-sun"></i>
<label class="switch">
<input type="checkbox" id="theme-toggle">
<span class="slider"></span>
</label>
<i class="fas fa-moon"></i>
</div>
<button id="bulk-export-button" title="Exportar Relatórios em Lote">
<i class="fas fa-file-export"></i>
</button>
<button id="export-html-button" title="Exportar Relatório HTML">
<i class="fas fa-file-invoice"></i>
</button>
<button id="export-csv-button" title="Exportar Resumo para CSV">
<i class="fas fa-file-csv"></i>
</button>
<button id="settings-button" title="Configurar Metas">
<i class="fas fa-cog"></i>
</button>
</div>
</header>

<section class="controls">
<div class="control-group"><label for="file-atividades"><i class="fas fa-tasks"></i> 1. Planilha de Atividades</label><input type="file" id="file-atividades" accept=".csv, .xlsx, .txt"></div>
<div class="control-group"><label for="file-clientes"><i class="fas fa-users"></i> 2. Planilha de Clientes</label><input type="file" id="file-clientes" accept=".csv, .xlsx, .txt"></div>
<div class="control-group">
<label for="select-period"><i class="fas fa-calendar-check"></i> Análise de Período</label>
<select id="select-period">
<option value="monthly" selected>Mensal</option>
<option value="q1">1º Trimestre</option>
<option value="q2">2º Trimestre</option>
<option value="q3">3º Trimestre</option>
<option value="q4">4º Trimestre</option>
<option value="s1">1º Semestre</option>
<option value="s2">2º Semestre</option>
<option value="year">Ano Inteiro</option>
</select>
</div>
<div class="control-group"><label for="select-year"><i class="fas fa-calendar-week"></i> Ano</label><select id="select-year"></select></div>
<div class="control-group"><label for="select-month"><i class="fas fa-calendar-alt"></i> Mês</label><select id="select-month"></select></div>
<div class="control-group"><label for="select-cs"><i class="fas fa-user-tie"></i> CS</label><select id="select-cs" disabled><option>Aguardando...</option></select></div>
<div id="squad-filter-group" class="control-group">
    <label for="select-squad"><i class="fas fa-users"></i> Squad</label>
    <select id="select-squad" disabled><option>Aguardando...</option></select>
</div>
<div class="control-group"><label for="select-segmento"><i class="fas fa-chart-pie"></i> Segmento</label><select id="select-segmento" disabled><option>Aguardando...</option></select></div>
<div class="control-group">
<label for="select-comparison"><i class="fas fa-exchange-alt"></i> Comparar com</label>
<select id="select-comparison">
<option value="none" selected>Nenhum</option>
<option value="prev_month">Mês Anterior</option>
<option value="prev_year">Mesmo Mês, Ano Anterior</option>
</select>
</div>
<div class="control-group">
<label for="include-onboarding-toggle">Incluir Onboarding</label>
<label class="switch">
<input type="checkbox" id="include-onboarding-toggle">
<span class="slider"></span>
</label>
</div>
</section>

<div id="squad-cs-list" style="text-align: center; margin: -15px 0 20px 0; color: var(--text-light-color); font-style: italic;"></div>

<div id="divergence-marker" class="divergence-info" style="display: none;">
<span id="divergence-text"></span>
</div>

<div id="status-message" class="loader">Por favor, carregue as duas planilhas para começar.</div>

<div class="tabs" style="display: none;">
<button class="tab-button active" data-tab="dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
<button class="tab-button" data-tab="onboarding-view"><i class="fas fa-rocket"></i> Onboarding</button>
<button class="tab-button" data-tab="overdue-view" style="color: var(--danger-color);"><i class="fas fa-clock-rotate-left"></i> Atrasadas</button>
<button class="tab-button" data-tab="data-view"><i class="fas fa-table"></i> Dados Carregados</button>
</div>

<main id="main-content">
<div id="dashboard-view" class="tab-content active">
<div id="dashboard" style="display: none;">

<div class="metric-group">
<h2 class="group-title">Indicadores Gerais da Carteira</h2>
<div class="group-content" id="general-indicators-grid"></div>
</div>

<div class="metric-group">
<h2 class="group-title">Acompanhamento de Playbooks</h2>
<div class="group-content" id="playbooks-grid"></div>
</div>

<div class="metric-group">
<h2 class="group-title" id="okr-title-header">OKRs de Engajamento e Eventos</h2>
<div class="group-content" id="okr-grid-container"></div>
</div>

</div>
<div id="period-view" style="display: none;">
</div>
</div>

<div id="onboarding-view" class="tab-content">
<div id="onboarding-dashboard" style="display: none;">
<section class="onboarding-controls">
<div class="control-group">
<label for="select-onboarding-team"><i class="fas fa-users-cog"></i> Visão do Time</label>
<select id="select-onboarding-team" disabled>
<option value="geral">Visão Geral</option>
<option value="syneco">Syneco (Time CP)</option>
<option value="outros">Outros Produtos (Time CS)</option>
</select>
</div>
<div class="control-group">
<label for="select-ism"><i class="fas fa-user-astronaut"></i> ISM Responsável</label>
<select id="select-ism" disabled><option>Aguardando...</option></select>
</div>
</section>

<div class="metric-group">
<h2 class="group-title" id="onboarding-general-title">Visão Geral do Onboarding</h2>
<div class="group-content" id="onboarding-general-grid"></div>
</div>
<div class="metric-group">
<h2 class="group-title" id="onboarding-activities-title">Acompanhamento de Atividades</h2>
<div class="group-content" id="onboarding-activities-grid"></div>
</div>
</div>
</div>

<div id="overdue-view" class="tab-content">
<div class="metric-group">
<h2 class="group-title">Visão de Atividades Atrasadas</h2>
<div class="group-content" id="overdue-grid-container">
<div class="loader">Selecione um CS para ver as atividades atrasadas.</div>
</div>
</div>
</div>

<div id="data-view" class="tab-content">
<div class="data-table-wrapper">
<h3><i class="fas fa-clipboard-list" style="margin-right:10px; color: var(--primary-color);"></i>Dados da Planilha de Atividades</h3>
<div id="atividades-table" class="data-table-container"></div>
<div id="atividades-pagination" class="pagination-controls"></div>
</div>
<div class="data-table-wrapper">
<h3><i class="fas fa-address-book" style="margin-right:10px; color: var(--primary-color);"></i>Dados da Planilha de Clientes</h3>
<div id="clientes-table" class="data-table-container"></div>
<div id="clientes-pagination" class="pagination-controls"></div>
</div>
</div>
</main>
</div>

<div id="details-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="modal-title">Detalhes</h2>
<span class="close-button">&times;</span>
</div>
<div class="modal-search-container">
<input type="search" id="modal-search-input" placeholder="Pesquisar por cliente, atividade, etc...">
</div>
<div id="modal-body" class="data-table-container"></div>
</div>
</div>

<div id="settings-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2><i class="fas fa-bullseye" style="margin-right:15px;"></i>Configurar Metas</h2>
<span class="close-button">&times;</span>
</div>
<div class="settings-grid">
<div class="control-group"><label for="goal-sensescore">Média Sense Score</label><input type="number" id="goal-sensescore" step="1"></div>
<div class="control-group"><label for="goal-labs">Participação SKA LABS (%)</label><input type="number" id="goal-labs" step="1"></div>
<div class="control-group"><label for="goal-coverage">Cobertura de Carteira (%)</label><input type="number" id="goal-coverage" step="1"></div>
<div class="control-group"><label for="goal-qbr">Ligações de QBR (nº)</label><input type="number" id="goal-qbr" step="1"></div>
<div class="control-group"><label for="goal-successplan">Planos de Sucesso (nº)</label><input type="number" id="goal-successplan" step="1"></div>
<div class="control-group"><label for="goal-engagement">Performance Engajamento SMB (%)</label><input type="number" id="goal-engagement" step="1"></div>
<button id="save-settings-button"><i class="fas fa-save" style="margin-right:10px;"></i>Salvar Metas</button>
</div>
</div>
</div>

<div id="client-360-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="client-360-name">Visão 360° do Cliente</h2>
<span class="close-button">&times;</span>
</div>
<div id="client-360-info" class="client-info"></div>
<div id="client-360-activities" class="data-table-wrapper" style="margin-bottom:0; box-shadow: none;">
<h3>Histórico de Atividades</h3>
<div class="data-table-container"></div>
</div>
</div>
</div>

<div id="trend-chart-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="trend-chart-title">Gráfico de Tendência</h2>
<span class="close-button">&times;</span>
</div>
<div id="trend-chart-container" style="padding: 20px 0;">
<canvas id="trend-chart-canvas"></canvas>
</div>
</div>
</div>

<div id="bulk-export-modal" class="modal">
<div class="modal-content" style="max-width: 600px;">
<div class="modal-header">
<h2><i class="fas fa-users" style="margin-right:15px;"></i>Exportar Relatórios em Lote</h2>
<span class="close-button">&times;</span>
</div>
<div id="cs-selection-list" style="margin: 20px 0; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm);">
</div>
<button id="generate-bulk-reports-button" style="width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 600; background-color: var(--secondary-color); color: #fff; border: none; border-radius: var(--border-radius-sm); cursor: pointer;">
<i class="fas fa-download" style="margin-right:10px;"></i>Gerar Relatórios Selecionados
</button>
</div>
</div>
</div> 
<script>
// --- LOGIN AUTHENTICATION SCRIPT ---
let currentUser = {
email: null,
name: null,
isManager: false
};

// Função para decodificar o token JWT recebido do Google
function parseJwt(token) {
try {
return JSON.parse(atob(token.split('.')[1]));
} catch (e) {
return null;
}
}

// Função chamada pelo Google após um login bem-sucedido
function handleCredentialResponse(response) {
const decodedToken = parseJwt(response.credential);

if (decodedToken) {
localStorage.setItem('googleUserToken', response.credential);
currentUser.email = decodedToken.email;
currentUser.name = decodedToken.name;

const managerEmails = ['lorhanska@gmail.com']; 
currentUser.isManager = managerEmails.includes(currentUser.email);

document.getElementById('login-container').style.display = 'none';
document.getElementById('dashboard-wrapper').style.display = 'block';

initializeDashboard(); 
} else {
alert("Falha no login. Não foi possível verificar suas credenciais. Tente novamente.");
localStorage.removeItem('googleUserToken');
}
}

// Função para fazer logout
function logout() {
localStorage.removeItem('googleUserToken');
google.accounts.id.disableAutoSelect();
location.reload();
}

// Função que verifica o estado do login assim que a página carrega
(function checkLoginState() {
const userToken = localStorage.getItem('googleUserToken');
if (userToken) {
const decodedToken = parseJwt(userToken);
if (decodedToken && (decodedToken.exp * 1000 > Date.now())) {
handleCredentialResponse({ credential: userToken });
} else {
localStorage.removeItem('googleUserToken');
}
}
})();

// O Dashboard só inicializa após o login
async function initializeDashboard() {
    // Tenta carregar dados do banco de dados ao iniciar
    const cachedData = await loadDataFromDB();
    if (cachedData) {
        rawActivities = cachedData.activities;
        rawClients = cachedData.clients;
        // Oculta os inputs de arquivo e mostra uma mensagem
        document.querySelector('[for="file-atividades"]').style.display = 'none';
        document.querySelector('[for="file-clientes"]').style.display = 'none';
        document.getElementById('file-atividades').style.display = 'none';
        document.getElementById('file-clientes').style.display = 'none';
        statusMessage.textContent = 'Dados carregados do cache. Processando...';
        processInitialData();
    }
/*
       -- INSTRUÇÃO PARA ATUALIZAÇÃO --
       Sempre que uma alteração funcional for implementada neste script,
       lembre-se de incrementar o número da revisão no HTML, no elemento <div class="revision-marker">.
       Exemplo: de "Rev. 5.1" para "Rev. 5.2".
       */

// --- NOVO: Exibe o card de usuário e configura o botão de logout ---
const userInfoCard = document.getElementById('user-info-card');
const userInfoText = document.getElementById('user-info-text');
const logoutButton = document.getElementById('logout-button');

if (currentUser.name) {
// Adiciona um ícone e o nome do usuário ao card
userInfoText.innerHTML = `<i class="fas fa-user-check" style="margin-right: 8px; color: var(--secondary-color);"></i> ${currentUser.name}`;
userInfoCard.style.display = 'flex';
}

logoutButton.addEventListener('click', logout);
// --- FIM DA NOVA LÓGICA DE USUÁRIO ---


// O código do dashboard agora é executado dentro desta função
const themeToggle = document.getElementById('theme-toggle');

const applyTheme = (isLight) => {
if (isLight) {
document.body.classList.add('light-theme');
localStorage.setItem('theme', 'light');
} else {
document.body.classList.remove('light-theme');
localStorage.setItem('theme', 'dark');
}
};

themeToggle.addEventListener('change', () => {
applyTheme(themeToggle.checked);
});

const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'light') {
themeToggle.checked = true;
applyTheme(true);
} else {
themeToggle.checked = false;
applyTheme(false);
}
const normalizeText = (str = '') => String(str).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
const getQuarter = (date) => Math.floor(date.getMonth() / 3);
const formatDate = (date) => {
if (!(date instanceof Date) || isNaN(date)) return '';
const day = String(date.getDate()).padStart(2, '0');
const month = String(date.getMonth() + 1).padStart(2, '0');
const year = date.getFullYear();
return `${day}/${month}/${year}`;
};

const parseDate = (dateInput) => {
if (!dateInput) return null;
if (dateInput instanceof Date) return dateInput;

const dateStr = String(dateInput).trim();

const parts = dateStr.split(/[-/]/);

if (parts.length !== 3 || parts[0].length !== 4) {
return null;
}

const year = parseInt(parts[0], 10);
const month = parseInt(parts[1], 10);
const day = parseInt(parts[2], 10);

if (isNaN(year) || isNaN(month) || isNaN(day)) {
return null;
}

const date = new Date(Date.UTC(year, month - 1, day));

if (date.getUTCFullYear() === year && date.getUTCMonth() === month - 1 && date.getUTCDate() === day) {
return date;
}

return null;
};

// Funções de banco de dados
const dbName = 'okrDashboardDB';
const storeName = 'spreadsheetData';

async function saveDataToDB(data) {
    const db = await idb.openDB(dbName, 1, {
        upgrade(db) {
            db.createObjectStore(storeName);
        },
    });
    await db.put(storeName, data, 'data');
    console.log('Dados salvos no IndexedDB com sucesso.');
}

async function loadDataFromDB() {
    try {
        const db = await idb.openDB(dbName, 1);
        const data = await db.get(storeName, 'data');
        if (data && data.activities && data.clients) {
            console.log('Dados carregados do IndexedDB.');
            return data;
        }
        return null;
    } catch (error) {
        console.error('Nenhum banco de dados encontrado ainda.', error);
        return null;
    }
}

async function clearDataFromDB() {
    const db = await idb.openDB(dbName, 1);
    await db.clear(storeName);
    alert('Cache de dados limpo! A página será recarregada.');
    location.reload();
}


const onboardingDashboard = document.getElementById('onboarding-dashboard');
const selectOnboardingTeam = document.getElementById('select-onboarding-team');
const selectISM = document.getElementById('select-ism');
const onboardingGeneralGrid = document.getElementById('onboarding-general-grid');
const onboardingActivitiesGrid = document.getElementById('onboarding-activities-grid');
const onboardingGeneralTitle = document.getElementById('onboarding-general-title');
const onboardingActivitiesTitle = document.getElementById('onboarding-activities-title');


const fileAtividadesInput = document.getElementById('file-atividades'), fileClientesInput = document.getElementById('file-clientes');
const selectCS = document.getElementById('select-cs'), selectSegmento = document.getElementById('select-segmento');
const selectMonth = document.getElementById('select-month'), selectYear = document.getElementById('select-year');
const selectPeriod = document.getElementById('select-period');
const onboardingToggle = document.getElementById('include-onboarding-toggle');
const statusMessage = document.getElementById('status-message'), dashboard = document.getElementById('dashboard');
const periodView = document.getElementById('period-view');
const okrGrid = document.getElementById('okr-grid-container'), generalGrid = document.getElementById('general-indicators-grid');
const playbookGrid = document.getElementById('playbooks-grid'), okrTitleHeader = document.getElementById('okr-title-header');
const tabsContainer = document.querySelector('.tabs');
const detailsModal = document.getElementById('details-modal'), settingsModal = document.getElementById('settings-modal'), client360Modal = document.getElementById('client-360-modal');

let rawActivities = [], rawClients = [];
let dataStore = {};
let onboardingDataStore = {};
let appGoals = {};
let csToSquadMap = new Map();
const defaultGoals = { sensescore: 85, labs: 10, coverage: 40, qbr: 5, successplan: 5, engagement: 20 };

const loadGoals = () => {
const savedGoals = localStorage.getItem('dashboardOKRsGoals');
appGoals = savedGoals ? JSON.parse(savedGoals) : { ...defaultGoals };
Object.keys(appGoals).forEach(key => {
const input = document.getElementById(`goal-${key}`);
if (input) input.value = appGoals[key];
});
};

const saveGoals = () => {
Object.keys(defaultGoals).forEach(key => {
const input = document.getElementById(`goal-${key}`);
if (input) { appGoals[key] = parseFloat(input.value) || defaultGoals[key]; }
});
localStorage.setItem('dashboardOKRsGoals', JSON.stringify(appGoals));
alert('Metas salvas com sucesso!');
settingsModal.style.display = 'none';
updateDashboard();
};

const readFile = (file) => new Promise((resolve, reject) => {

const excelSerialToDateObject = (serial) => {
const correctedSerial = serial + 1;
const excelTimestamp = (correctedSerial - 25569) * 86400 * 1000;
const timezoneOffset = new Date().getTimezoneOffset() * 60 * 1000;
return new Date(excelTimestamp + timezoneOffset);
}

const transpilePipeToCommaCSV = (pipeText) => {
let inQuotes = false;
let newCsvText = '';
for (let i = 0; i < pipeText.length; i++) {
const char = pipeText[i];
if (char === '"') inQuotes = !inQuotes;
newCsvText += (char === '|' && !inQuotes) ? ',' : char;
}
return newCsvText;
};

const reader = new FileReader();

reader.onload = (event) => {
try {
const data = event.target.result;
const fileName = file.name.toLowerCase();
let workbook;

if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
workbook = XLSX.read(data, { type: 'array', cellDates: true });
} else {
const standardCsvText = transpilePipeToCommaCSV(data);
workbook = XLSX.read(standardCsvText, { type: 'string' });
}

const sheetName = workbook.SheetNames[0];
const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });

const dateColumns = ["Criado em", "Previsão de conclusão", "Concluída em"];

jsonData.forEach(row => {
dateColumns.forEach(colName => {
if (row[colName] && typeof row[colName] === 'number') {
row[colName] = excelSerialToDateObject(row[colName]);
}
});
});

resolve(jsonData);

} catch (e) {
reject(new Error("Não foi possível processar o arquivo. Verifique se não está corrompido."));
}
};

reader.onerror = (error) => {
reject(new Error("Ocorreu um erro de hardware ou permissão ao tentar ler o arquivo."));
};

if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
reader.readAsArrayBuffer(file);
} else {
reader.readAsText(file, 'UTF-8'); 
}
});

const buildCsToSquadMap = () => {
    const allCSs = [...new Set(rawClients.map(c => c.CS).filter(Boolean))];
    allCSs.forEach(csName => {
        const clientsOfCS = rawClients.filter(c => c.CS === csName);
        if (!clientsOfCS.some(c => c['Squad CS'])) {
            return;
        }
        const squadCounts = clientsOfCS.reduce((acc, client) => {
            const squad = client['Squad CS'];
            if (squad) {
                acc[squad] = (acc[squad] || 0) + 1;
            }
            return acc;
        }, {});
        let majoritySquad = '';
        let maxCount = 0;
        for (const squad in squadCounts) {
            if (squadCounts[squad] > maxCount) {
                maxCount = squadCounts[squad];
                majoritySquad = squad;
            }
        }
        if (majoritySquad) {
            csToSquadMap.set(csName, majoritySquad);
        }
    });
};

const processInitialData = () => {
    statusMessage.textContent = 'Processando dados...';

    const clienteMap = new Map(rawClients.map(cli => [(cli.Cliente || '').trim().toLowerCase(), cli]));

    rawActivities = rawActivities.map(ativ => {
        const clienteKey = (ativ.Cliente || '').trim().toLowerCase();
        const clienteInfo = clienteMap.get(clienteKey) || {};
        return { 
            ...ativ, 
            ClienteCompleto: clienteKey, 
            Segmento: clienteInfo.Segmento, 
            CS: clienteInfo.CS,
            Squad: clienteInfo['Squad CS'],
            Fase: clienteInfo.Fase,
            ISM: clienteInfo.ISM,
            PrevisaoConclusao: parseDate(ativ['Previsão de conclusão']), 
            ConcluidaEm: parseDate(ativ['Concluída em']) 
        };
    });

    if (currentUser.isManager) {
        buildCsToSquadMap();
    }

    populateFilters();

    if (!currentUser.isManager) {
        const selectedCS = selectCS.value;
        if (selectedCS) {
            const clientsOfLoggedInUser = rawClients.filter(client => client.CS?.trim() === selectedCS);
            autoSelectSegment(clientsOfLoggedInUser);
        }
    }

    renderDataTables();
    statusMessage.style.display = 'none';
    dashboard.style.display = 'block';
    onboardingDashboard.style.display = 'block';
    tabsContainer.style.display = 'flex';
    const selectSquad = document.getElementById('select-squad');
    [selectCS, selectSquad, selectSegmento, selectMonth, selectYear, onboardingToggle, selectPeriod].forEach(el => el.disabled = false);
    
    if (!currentUser.isManager) {
        selectCS.disabled = true;
    }
    
    [selectOnboardingTeam, selectISM].forEach(el => el.disabled = false);
    
    updateDashboard();
    renderOverdueView();
};

const updateIsmFilter = () => {
const teamView = selectOnboardingTeam.value;
const onboardingClients = rawClients.filter(c => normalizeText(c.Fase) === 'onboarding');

let relevantClients = [];
if (teamView === 'syneco') {
relevantClients = onboardingClients.filter(c => normalizeText(c.Cliente).includes('syneco'));
} else if (teamView === 'outros') {
relevantClients = onboardingClients.filter(c => !normalizeText(c.Cliente).includes('syneco'));
} else {
relevantClients = onboardingClients;
}

const ismSet = new Set(relevantClients.map(c => c.ISM).filter(Boolean));
selectISM.innerHTML = '<option value="Todos">Todos os ISMs</option>';
[...ismSet].sort().forEach(ism => {
const option = document.createElement('option');
option.value = ism;
option.textContent = ism;
selectISM.appendChild(option);
});
};

const populateFilters = () => {
const csSet = new Set(rawClients.map(d => d.CS).filter(Boolean));
const selectSquad = document.getElementById('select-squad');
selectCS.innerHTML = ''; 

if (currentUser.isManager) {
selectCS.innerHTML += '<option value="Todos">Todos os CS</option>';
}

const sortedCS = [...csSet].sort();
sortedCS.forEach(cs => { 
const option = document.createElement('option'); 
option.value = cs; 
option.textContent = cs; 
selectCS.appendChild(option); 
});

if (!currentUser.isManager) {
    const userFirstName = currentUser.name.split(' ')[0];
    const matchingCS = sortedCS.find(cs => normalizeText(cs).includes(normalizeText(userFirstName)));
    if (matchingCS) {
        selectCS.value = matchingCS;
    }
    selectCS.disabled = true;
}

if (currentUser.isManager) {
    const squadSet = new Set(rawClients.map(d => d['Squad CS']).filter(Boolean));
    selectSquad.innerHTML = '<option value="Todos">Todos os Squads</option>';
    const sortedSquads = [...squadSet].sort();
    sortedSquads.forEach(squad => {
        const option = document.createElement('option');
        option.value = squad;
        option.textContent = squad;
        selectSquad.appendChild(option);
    });
}

updateIsmFilter();

const segmentosPredefinidos = ["SMB CAD", "SMB Multiprodutos", "MID/Enterprise"];
selectSegmento.innerHTML = '';
segmentosPredefinidos.forEach(seg => { const option = document.createElement('option'); option.value = seg; option.textContent = seg; selectSegmento.appendChild(option); });

const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
selectMonth.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

const allDates = [...rawActivities.map(a => a.PrevisaoConclusao), ...rawActivities.map(a => a.ConcluidaEm)];
const years = [...new Set(allDates.map(d => d?.getFullYear()).filter(Boolean))].sort((a,b) => b-a);
selectYear.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

const today = new Date();
selectMonth.value = today.getMonth();
if (years.includes(today.getFullYear())) {
selectYear.value = today.getFullYear();
} else if (years.length > 0) {
selectYear.value = years[0];
}
};

// --- CONTROLE DE ACESSO VISUAL --- (Movido para o final da função initializeDashboard)
if (!currentUser.isManager) {
    document.getElementById('settings-button').style.display = 'none';
    document.getElementById('bulk-export-button').style.display = 'none';
    document.getElementById('squad-filter-group').style.display = 'none';
    document.getElementById('squad-cs-list').style.display = 'none';
    const csLabel = document.querySelector('[for="select-cs"]');
    if(csLabel) {
        csLabel.style.pointerEvents = 'none';
        csLabel.style.opacity = '0.6';
    }
}
} 
</script>
</body>
</html>
